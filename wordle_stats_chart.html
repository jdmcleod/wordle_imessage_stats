<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wordle Stats Line Chart</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Rubik', sans-serif;
      margin: 0;
      padding: 1em;
      height: 100vh;
      box-sizing: border-box;
    }
    h1 {
      margin: 0 0 1em 0;
      text-align: center;
      font-size: 2em;
    }
    .back-link {
      position: absolute;
      top: 1em;
      left: 1em;
      text-decoration: none;
      color: #666;
      font-size: 14px;
      z-index: 10;
    }
    .back-link:hover {
      color: #333;
    }
    #chart-container {
      width: 100%;
      height: calc(100vh - 80px);
      min-width: 600px;
      overflow-x: auto;
    }

    @media (max-width: 768px) {
      body {
        padding: 0.5em;
        overflow-x: auto;
      }

      h1 {
        font-size: 1.5em;
        margin: 2.5em 0 0.5em 0;
        padding: 0 0.5em;
      }

      .back-link {
        position: relative;
        top: auto;
        left: auto;
        display: block;
        margin-bottom: 1em;
        font-size: 16px;
      }

      #chart-container {
        height: calc(100vh - 120px);
        min-width: 800px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.3em;
      }

      #chart-container {
        height: calc(100vh - 100px);
        min-width: 900px;
      }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
  <h1>Wordle Stats Line Chart</h1>
  <div id="chart-container">
    <canvas id="stats-chart"></canvas>
  </div>
  <script>
    function parseStats(data) {
      const allDates = new Set();
      data.forEach(person => {
        person.scores.forEach(s => {
          const date = s.date.split('T')[0];
          allDates.add(date);
        });
      });
      const sortedDates = Array.from(allDates).sort();

      // Calculate recent average (last 14 days) for each person
      const recentCutoff = new Date();
      recentCutoff.setDate(recentCutoff.getDate() - 14);
      const recentCutoffStr = recentCutoff.toISOString().split('T')[0];

      const recentAverages = data.map(person => {
        const recentScores = person.scores.filter(s => s.date.split('T')[0] >= recentCutoffStr);
        const avg = recentScores.length > 0 ?
          recentScores.reduce((sum, s) => sum + s.score, 0) / recentScores.length : Infinity;
        return { name: person.name, avg };
      });

      const bestPerformer = recentAverages.reduce((best, current) =>
        current.avg < best.avg ? current : best
      );

      const colors = [
        '#FF6B6B', '#a5ffb6', '#45B7D1', '#FECA57',
        '#FF9FF3', '#54A0FF', '#5F27CD', '#FF9F43',
        '#E84393', '#4f9d0d', '#b60000', '#220cab'
      ];

      const datasets = data.map((person, idx) => {
        const color = colors[idx % colors.length];
        const dateToScore = {};
        person.scores.forEach(s => {
          const date = s.date.split('T')[0];
          dateToScore[date] = s.score;
        });

        const label = person.name === bestPerformer.name ?
          `${person.name} üî•` : person.name;

        return {
          label,
          data: sortedDates.map(date => dateToScore[date] ?? null),
          borderColor: color,
          backgroundColor: color,
          spanGaps: true,
          tension: 0.2
        };
      });
      return { labels: sortedDates, datasets };
    }

    // Load data and draw chart on page load
    fetch('data/wordle_stats.json')
      .then(response => response.json())
      .then(data => {
        const chartData = parseStats(data);
        const chart = new Chart(document.getElementById('stats-chart').getContext('2d'), {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Wordle Scores Per Day' },
              legend: {
                display: true,
                onClick: (e, legendItem) => {
                  const index = legendItem.datasetIndex;
                  const datasets = chart.data.datasets;

                  // Check if this dataset is already highlighted
                  const isHighlighted = datasets[index].borderWidth === 4;

                  if (isHighlighted) {
                    // Reset all to normal state
                    datasets.forEach((dataset) => {
                      dataset.borderWidth = 2;
                      dataset.pointRadius = 3;
                      dataset.backgroundColor = dataset.borderColor;
                    });
                  } else {
                    // Highlight selected dataset
                    datasets.forEach((dataset, i) => {
                      if (i === index) {
                        dataset.borderWidth = 4;
                        dataset.pointRadius = 6;
                        dataset.backgroundColor = dataset.borderColor;
                      } else {
                        dataset.borderWidth = 1;
                        dataset.pointRadius = 3;
                        const color = dataset.borderColor;
                        dataset.backgroundColor = color + '40';
                      }
                    });
                  }

                  chart.update();
                }
              }
            },
            scales: {
              y: {
                title: { display: true, text: 'Score' },
                beginAtZero: true,
                reverse: true,
                ticks: {
                  stepSize: 0.5
                }
              },
              x: { title: { display: true, text: 'Date' } }
            }
          }
        });
      })
      .catch(error => {
        console.error('Error loading wordle stats:', error);
        document.getElementById('chart-container').innerHTML = '<p>Error loading data. Make sure you are serving this file from a web server.</p>';
      });
  </script>
</body>
</html>
